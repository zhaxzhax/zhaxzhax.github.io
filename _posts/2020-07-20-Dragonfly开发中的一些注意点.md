---
layout: post
title:  "Dragonfly开发中的一些注意点"
date:   2020-07-20 22:10:00 +0800
tags:
  - dragonfly
  - golang
categories:
  - Dragonfly
  - GoLang
---
> 参加了阿里的ASOC，开源项目选择为Dragonfly，遇到了一些问题，在这里记录一下

# 一些配置
### 换行符问题
windows下的bash脚本为`\r\n`换行，`dos`格式。而linux或mac系统下为`unix`格式。在我们通过git拉取文件时，会自动将换行格式调整为`dos`格式，导致我在`wsl`下调用`makefile`时提示错误。同时转换为`dos`格式后，提交`commit`也会污染源代码库。
这里是一些有关的命令
```
    #提交时转换为LF，检出时转换为CRLF
    git config --global core.autocrlf true
    
    #提交时转换为LF，检出时不转换
    git config --global core.autocrlf input
    
    #提交检出均不转换
    git config --global core.autocrlf false
    
    #拒绝提交包含混合换行符的文件
    git config --global core.safecrlf true
    
    #允许提交包含混合换行符的文件
    git config --global core.safecrlf false
    
    #提交包含混合换行符的文件时给出警告
    git config --global core.safecrlf warn
	
	#设置行结束符的类型为lf
    git config --global core.eol lf

	#设置行结束符的类型为crlf
	git config --global core.eol crlf
	
	#设置行结束符的类型为native, native是指平台默认的行结束符。默认的类型是native
	git config --global core.eol native
```
在这里我选择`git config --global core.autocrlf input`以及`git config --global core.safecrlf true`来保证拉取到的代码能在`wsl`环境下运行。

### go proxy 问题
在运行go程序时，出现连接断开，无法拉取到所需的pkg。这种情况一般是`go proxy`设置问题。
+ 设置GOPROXY代理：
```
go env -w GOPROXY=https://goproxy.cn,direct
```
+ 打开GO111MODULE
```
go env -w GO111MODULE=on
```
+ 设置GOPRIVATE来跳过私有库，比如常用的Gitlab或Gitee，中间使用逗号分隔：
```
go env -w GOPRIVATE=*.gitlab.com,*.gitee.com
```
+ 如果在运行go mod vendor时，提示Get https://sum.golang.org/lookup/xxxxxx: dial tcp 216.58.200.49:443: i/o timeout，则是因为Go 1.13设置了默认的GOSUMDB=sum.golang.org，这个网站是被墙了的，用于验证包的有效性，可以通过如下命令关闭：
```
go env -w GOSUMDB=off
```
+ 可以设置 GOSUMDB="sum.golang.google.cn"， 这个是专门为国内提供的sum 验证服务：
```
go env -w GOSUMDB="sum.golang.google.cn"
```
+ -w 标记 要求一个或多个形式为 NAME=VALUE 的参数， 并且覆盖默认的设置


### api生成
api通过`swagger`生成
> Dragonfly only has generated API types via tool [swagger](https://swagger.io). These structs are all located in directory `apis/types`. For your attention, these files are totally auto generated by swagger. It is **FORBIDDEN** to edit files in directory `apis/types` directly. If you need to update one or more files in `apis/types`, please edit file `apis/swagger.yml` and auto generate corresponding API struct files. What's more, API structs in `apis/types` must be used in both client side and daemon side. If one struct defined in these files is only used in one of client and daemon side, then this struct is not proper to be defined in swagger.yml. We **MUST** move it out of `apis/types` to client side or daemon side. In a word, swagger.yml is the **ONLY** entry to define Dragonfly supernode's API. And this will guarantee the efficiency and standard of Dragonfly supernode's API defining.

直接修改api文件是被禁止的。
### 命令行参数
命令行定制程序采用`cobra`生成
### 画图
`plantuml`
### 日志
日志采用`logrus`
### makefile
该项目的`makefile`配合`hack`文件夹下的脚本可以实现项目本地编译，项目编译到docker，项目测试，项目生成文档，项目安装，项目卸载等多种功能。目测可以通过该`makefile`省去很多命令行操作。
### 仿真测试
`gomock`
### API问题
api版本混杂，存在0.3版本与1.0版本。另外部分1.0版本api在文档中列出，却并没有实现。对于client文件夹下的接口，也没有完全实现`swagger.yml`中全部的接口。
# 我的方案初步实现
### 一些思路
我目前的想法是，在dynamic模式下，不存在`localLimit`以及`totalLimit`,只有一个`dynamicRate`控制带宽。
### 命令行参数
增加了参数 `dynamic`用于控制动态调节带宽的开关，`dynamicRate`用于设置初始的动态带宽
### api接口
更改了v0.3的`/peer/task`接口，增加了`dynamicRate`参数
### HTBListener
还没做
# 我的中期方案设计
### 一些思路
+ ~~现在来看初步的方案不太行，还是对带宽控制理解的不太透彻。其实只要控制上行带宽就行了。我目前的想法是调整`totalLimit`来控制一个主机总的上行带宽。但由于一个主机会有多个`server`，而多个`server`的带宽改变会不会影响正在下载的任务呢？我还不知道，慢慢看吧。
事实上一个dfget下载任务，就会建立一个server。而这个server可以同时服务这个文件任意`piece`的下载。也就是是说，一个主机上有多个server，一个server有多个下载任务。如果我们给一个server提供可用带宽的90%，那么下一个server获得的可能就是原先可用带宽的10%的90%。但如果保证通过server平均分配带宽，又会导致task较多的server带宽拥堵，task少的server带宽浪费。我的计划是每个server存储自己的task数量，并进行动态带宽的按比例分配。~~
错了，每个host只有一个server，并且有时候开，有时候关。
+ DynamicRate 数据Race问题
+ 算法无法控制 totalLimiter问题
### 设计与实现方案
#### cli的添加
`--dynamic`开启动态带宽功能
#### api的添加
添加了两个api，用于peerserver向supernode传递带宽更新信息
+ `/api/v1/peer/{id}/peerState/{dynamicRate}` 1.0版本的api
+ `/peer/dynamicrate` 0.3版本的api **(0.3版本的api需要修改，传task数组即可，调用多次开销太大)**
#### 字段的添加
+ 对于`PeerState`添加了`DynamicRate`属性
#### 具体的实现逻辑
+ `host_bandwidth_listener`监听带宽，将可用带宽的百分之九十设置为`totalLimit`，并作为`dynamicRate`传输至supernode
+ supernode根据`dynamicRate`以及`ProducerLoad`对`peer`进行优先级排序，调度算法将调度优先级更高的`peer`
#### 带宽监听
<!-- ~~+ nethogs
> yum install nethogs

> sudo apt install nethogs ~~ -->
+ cat /proc/net/dev 计算总带宽
+ 增加 maxBandwidth 协程 用于更新最大带宽
+ 固定带宽通过 gopacket抓包分析
#### 带宽监听修改
+ 
+ api修改，减少请求次数
+ 去除对gopacket依赖，粗略计算带宽
+ 通过配置项配置最大带宽dynamicMaxRate